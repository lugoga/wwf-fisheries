---
title: "Fisheries performance in Rumaki and Non-Rumaki Areas"
author: 
- Baraka Kuguru
- Mathias Igulu
- Masumbuko Semba
date: "`r Sys.Date()`"
output: memor::pdf_memo
---


# Fisheries in Rumaki and Non-Rumaki Areas

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, comment = FALSE)
```

```{r}
require(tidyverse)
require(ggpubr)
require(sf)
require(ggspatial)
```



```{r}
species = read_csv("./data_update/All data combined_cleaned.csv")

species = species %>% separate(Eng_name, c("Genus", "Species"), sep = " ", remove = FALSE)

# species %>% distinct(Genus) %>% arrange(Genus)
```

```{r}

dominant.group = bind_rows(
      species%>%
        filter(Genus == "Lethrinus") %>%
        mutate(group = "Reef fish"),
      
      species%>%
        filter(Genus %in% c("Euthynus", "Scomberomorus", "Thunnus", "Tuna", "Xiphias ")) %>%
        mutate(group = "Tuna fish"),
      
      species%>%
        filter(Genus == "Octopus") %>%
        mutate(group = "Octopus"),
      
      species%>%
        filter(Genus %in% c("Mackerel", "Sardinella")) %>%
        mutate(group = "Small pelagic")
) %>%
  mutate(catch = as.numeric(`Catch(t)`))


```




```{r fig101, fig.cap="Trend of error free catch data per each site"}

catch.clean.group.outlierfree = list()
sites = dominant.group %>% distinct(Districts) %>% pull()

for (i in 1:length(sites)){
  
  dummy = dominant.group %>% filter(Districts == sites[i])
    q = quantile(dummy$catch, na.rm = TRUE)
    iqr = IQR(dummy$catch, na.rm = TRUE) # alternative: iqr = q[4]-q[2]
    
    lower = q[2] - (1.5 * iqr)
    upper = q[4] + (1.5 * iqr)
    
 catch.clean.group.outlierfree[[i]] = dummy %>% 
   filter(catch > lower & catch <= upper)
  
}

catch.clean.group.outlierfree = catch.clean.group.outlierfree %>% 
  bind_rows() %>%
  mutate(Districts = replace(Districts, Districts=="Kindondoni", "Kinondoni"),
         Districts = replace(Districts, Districts=="Lindi urban","Lindi Urban"),
         Districts = replace(Districts, Districts=="Lindi", "Lindi Urban"))


```

```{r}
tz = st_read("e:/GIS/tanzania-latest.shp/nbs/Districts.shp", quiet = TRUE )


```

```{r}
rumaki.districts = catch.clean.group.outlierfree %>% distinct(Districts) %>% pull()
rumaki.districts[3] = "Tanga Urban"
rumaki.districts[16] = "Lindi"

coastal = tz %>% filter(District_N %in% rumaki.districts)

coastal %>% mapview::mapview()

catch.clean.join = catch.clean.group.outlierfree %>% 
  # filter(group == "Reef fish") %>% 
  mutate(Districts = replace(Districts, Districts == "Kigamboni", "Temeke"),
         Districts = replace(Districts, Districts == "Kibiti", "Mafia"), 
         Districts = replace(Districts, Districts == "Lindi Rural", "Lindi"),
         Districts = replace(Districts, Districts == "Mtwara Rural", "Mtwara")) %>%
  group_by(Districts, Zone, group) %>% summarise(catch = mean(catch, na.rm = TRUE)) %>%
  ungroup()


catch.clean.join.spatial = coastal %>% 
  rename(Districts = District_N)  %>% 
  full_join(catch.clean.join) %>%
  mutate(class = cut(catch, breaks = seq(0,400,75), 
                     labels = c("Below 75", "75-150", "150-225", "225-300", "above 300")))

 
```


```{r}
coordinates = catch.clean.join.spatial %>% 
                  # filter(Zone == "OTHER" & group == "Tuna fish") %>%
  select(Districts, group) %>% 
  st_centroid() %>% 
  st_coordinates() %>% 
  as_tibble() %>% 
  rename(lon = 1, lat = 2) %>%
  bind_cols(
    catch.clean.join.spatial %>% 
      # filter(Zone == "OTHER" & group == "Tuna fish") %>%
      select(Districts, group) %>% st_drop_geometry()
  )


```

```{r, eval=FALSE}
ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% filter(Zone == "OTHER")%>% 
                  st_simplify(dTolerance = .015),
                aes(fill = class), col = NA)+
   # ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6), 
   #                          aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  facet_wrap(~group, nrow = 1) +
  ggsci::scale_fill_locuszoom() +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
   cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "right", 
        legend.key.width = unit(.5,"cm"))
```

# Spatial catch variation in Non Rumaki

```{r fig3, fig.cap="Octopus catch variation over Non-Rumaki Area"}

ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  filter(Zone == "OTHER" & group == "Octopus") %>% 
                  st_simplify(dTolerance = 0),
          aes(fill = class), col = "ivory") +
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6 & group == "Octopus"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .75)+
  labs(x = "", y = "")
```

```{r fig4, fig.cap="Tuna fish catch variation over Non-Rumaki Area"}

ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  filter(Zone == "OTHER" & group == "Tuna fish") %>% 
                  st_simplify(dTolerance = 0),
          aes(fill = class), col = "ivory") +
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6 & group == "Tuna fish"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .75)+
  labs(x = "", y = "")
```

```{r fig5, fig.cap="Small pelagic catch variation over Non-Rumaki Area"}

ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  filter(Zone == "OTHER" & group == "Small pelagic") %>% 
                  st_simplify(dTolerance = 0),
          aes(fill = class), col = "ivory") +
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6 & group == "Small pelagic"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .75)+
  labs(x = "", y = "")
```

```{r fig6, fig.cap="Reef fish catch variation over Non-Rumaki Area"}
ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  filter(Zone == "OTHER" & group == "Reef fish") %>% 
                  st_simplify(dTolerance = 0),
          aes(fill = class), col = "ivory") +
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6 & group == "Reef fish"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .75)+
  labs(x = "", y = "")
```

# Spatial catch variation in Rumaki

```{r fig7, fig.cap="Octopus catch variation accross Rumaki Area"}
 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% na.omit() %>% filter(group == "Octopus"),
          aes(fill = class), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat <= -7.6 & group == "Octopus"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-7.5), crs = 4326)+
  ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")

```


```{r fig8, fig.cap="Reef fish catch variation accross Rumaki Area"}
 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% na.omit() %>% filter(group == "Reef fish"),
          aes(fill = class), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat <= -7.6 & group == "Reef fish"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-7.5), crs = 4326)+
  ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")

```


```{r fig9, fig.cap="Tuna catch variation accross Rumaki Area"}
 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% na.omit() %>% filter(group == "Tuna fish"),
          aes(fill = class), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat <= -7.6 & group == "Tuna fish"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-7.5), crs = 4326)+
  ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")

```


```{r fig10, fig.cap="Small pelagic catch variation accross Rumaki Area"}
 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% na.omit() %>% filter(group == "Small pelagic"),
          aes(fill = class), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat <= -7.6 & group == "Small pelagic"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-7.5), crs = 4326)+
  ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")

```


# Regression and correlation of annual fish catches over study period

```{r fig11, fig.cap="District in Rumaki areas with relatively stable annual catches", fig.height=3.5, fig.width=3.5}


formula1 <- y ~ x

ggplot(data = catch.clean.group.outlierfree %>% filter(Zone == "RUMAKI" & Districts %in% c("Rufiji", "Mafia")) , 
       aes(x = Year, y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(2015,2017)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts)+
  labs(x = "", y = "Fish catch (Tonnes)")


```


```{r fig12, fig.cap="District in Rumaki areas with relatively decline annual catches", fig.width=6, fig.height=4}

ggplot(data = catch.clean.group.outlierfree %>% filter(Zone == "RUMAKI" & !Districts %in% c("Rufiji", "Mafia")) , 
       aes(x = Year, y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(2015,2017)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")
```



```{r fig13, fig.cap="District in Non-Rumaki areas with relatively decline annual catches", fig.width=6, fig.height=4}


formula1 <- y ~ x

ggplot(data = catch.clean.group.outlierfree %>% 
         filter(Zone == "OTHER" & 
                  Districts %in% c("Ilala", "Pangani", "Tanga", "Temeke", "Lindi Urban")) , 
       aes(x = Year, y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(2015,2017)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")


```


```{r fig14, fig.cap="District in Non-Rumaki areas with relatively stable annual catches", fig.width=6, fig.height=4}

ggplot(data = catch.clean.group.outlierfree %>% 
         filter(Zone == "OTHER" & 
                  !Districts %in% c("Ilala", "Pangani", "Tanga", "Temeke", "Lindi Urban")) , 
       aes(x = Year, y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(2015,2017)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")
```


# Catches of common fish groups


```{r fig15, fig.cap="Catches of four common fish group in Rumaki and Non-Rumaki area"}
catch.clean.group.outlierfree %>%
  ggplot(aes(x = Year %>% as_factor(), y = catch, fill = Zone, col = Zone))+
  geom_boxplot(alpha = .4)+
  facet_wrap(~group)+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "bottom")+
  labs(x = "", y = "Fish catch (Tonnes)")+
  scale_fill_discrete(name = "")+
  scale_color_discrete(name = "")

```

```{r fig16, fig.cap="Catches pooled for the four common fish group in Rumaki and Non-Rumaki area", fig.height=3.5, fig.width=4}
catch.zone = catch.clean.group.outlierfree %>% group_by(Year,Zone) %>% 
  summarise(n = n(),
            catch.mean = mean(catch, na.rm = TRUE),
            catch.median = median(catch, na.rm = TRUE),
            catch.sd = sd(catch, na.rm = TRUE),
            catch.se = catch.sd/sqrt(n)) %>%
  ungroup() 

catch.zone %>% 
  ggplot(aes(x = Year, y = catch.median, col = Zone)) +
  geom_line() +
  geom_errorbar(aes(ymin = catch.median - catch.se, 
                    ymax = catch.median + catch.se), width = 0.075)+
  geom_point(size = 3)+
  # facet_wrap(~group, strip.position = "top" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = c(.4,.9), 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")+
   ggsci::scale_color_d3(name = "")

```


```{r fig17, fig.cap="Mean Catches and standard error for the four common fish group in Rumaki and Non-Rumaki area", fig.width=5, fig.height=4}
catch.stats = catch.clean.group.outlierfree %>% group_by(Year,Zone, group) %>% 
  summarise(n = n(),
            catch.mean = mean(catch, na.rm = TRUE),
            catch.median = median(catch, na.rm = TRUE),
            catch.sd = sd(catch, na.rm = TRUE),
            catch.se = catch.sd/sqrt(n)) %>%
  ungroup() 


catch.stats %>% 
  ggplot(aes(x = Year, y = catch.median, col = Zone)) +
  geom_line() +
  geom_errorbar(aes(ymin = catch.median - catch.se, 
                    ymax = catch.median + catch.se), width = 0.075)+  
  geom_point(size = 3)+
  facet_wrap(~group, strip.position = "top" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "bottom", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")+
   ggsci::scale_color_d3(name = "")+
  scale_x_continuous(breaks = 2014:2017)

```

```{r fig18, fig.cap="Reef fish catches in Rumaki and Non-Rumaki area", fig.width=4.5, fig.height=3.5}

 
 catch.stats %>% filter(group == "Reef fish") %>%
  ggplot(aes(x = Year, y = catch.median, col = Zone)) +
  geom_line() +
    geom_errorbar(aes(ymin = catch.median - catch.se, 
                    ymax = catch.median + catch.se), width = 0.075)+
  geom_point(size = 4)+
  # facet_wrap(~group, strip.position = "top" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = c(.5,.8), 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")+
   ggsci::scale_color_d3(name = "")

```


# Rate of Change in Catches

```{r fig19, fig.cap="Catches anomaly using the 2018 catches as reference for Rumaki and Non-Rumaki area", fig.width=6, fig.height=4}
## compute the lead anomaly use 2018 catches as reference value
lead.others = catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>% 
  mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  arrange(date, zone) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  filter(zone == "OTHER")%>%
  mutate(octopus.lead = Octopus - lead(Octopus),
         reef.lead = `Reef fish` - lead(`Reef fish`),
         pelagic.lead = `Small pelagic` - lead(`Small pelagic`),
         tuna.lead = `Tuna fish` - lead(`Tuna fish`)) %>%
  select(date, year, zone, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead) %>%
  pivot_longer(cols = 4:7, names_to = "group") 

lead.rumaki = catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>% 
  mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  arrange(date, zone) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  filter(zone == "RUMAKI")%>%
  mutate(octopus.lead = Octopus - lead(Octopus),
         reef.lead = `Reef fish` - lead(`Reef fish`),
         pelagic.lead = `Small pelagic` - lead(`Small pelagic`),
         tuna.lead = `Tuna fish` - lead(`Tuna fish`)) %>%
  select(date, year, zone, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead) %>%
  pivot_longer(cols = 4:7, names_to = "group")

lead.catch.anomaly = lead.others %>%
  bind_rows(lead.rumaki)

lead.catch.anomaly %>% 
  ggplot(aes(x = year, y = value, col = zone)) +
  geom_line() +
  geom_point(size = 3)+
  facet_wrap(~group, strip.position = NULL , scales = "free_y")+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "bottom", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Catch anomaly (Tonnes)")+
   ggsci::scale_color_d3(name = "")
```



```{r fig20, fig.cap="Rate of change of catches in percentage for Rumaki and Non-Rumaki area", fig.width=6, fig.height=4}

## rate of change in percentage of catch

percentage.others = catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>% 
  mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  arrange(date, zone) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  filter(zone == "OTHER")%>%
  mutate(octopus.lead = Octopus/sum(Octopus)*100,
         reef.lead = `Reef fish`/sum(`Reef fish`)*100,
         pelagic.lead = `Small pelagic`/sum(`Small pelagic`)*100,
         tuna.lead = `Tuna fish`/sum(`Tuna fish`)*100) %>%
  select(date, year, zone, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead) %>%
  pivot_longer(cols = 4:7, names_to = "group") 



percentage.rumaki = catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>% 
  mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  arrange(date, zone) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  filter(zone == "RUMAKI")%>%
  mutate(octopus.lead = Octopus/sum(Octopus)*100,
         reef.lead = `Reef fish`/sum(`Reef fish`)*100,
         pelagic.lead = `Small pelagic`/sum(`Small pelagic`)*100,
         tuna.lead = `Tuna fish`/sum(`Tuna fish`)*100) %>%
  select(date, year, zone, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead) %>%
  pivot_longer(cols = 4:7, names_to = "group")

catch.percentage = percentage.others %>%
  bind_rows(percentage.rumaki)

catch.percentage %>% 
  ggplot(aes(x = year, y = value, col = zone)) +
  geom_line() +
  geom_point(size = 3)+
  facet_wrap(~group, strip.position = NULL )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "bottom", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Catch Rate (%)")+
   ggsci::scale_color_d3(name = "")+
  scale_x_continuous(breaks = 2014:2017)
```



```{r}
catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>%
  kableExtra::kable(format = "latex", caption = "Annual mean averages of common fish groups",
                    digits = 2, align = "c", booktabs = TRUE,
                    col.names = c("Year", "Area", "Octopus", "Reef", "Pelagic", "Tuna")) %>%
  kableExtra::column_spec(column = 1, width = "2cm") %>% 
  kableExtra::column_spec(column = 2:6, width = "2.5cm") %>%
  kableExtra::add_header_above(c("", "", "Fish catches (Tonnes)" = 4))

```


```{r, eval=FALSE}
require(tsbox)

reef.rumaki = catch.stats %>% 
  filter(group == "Reef fish" & Zone == "RUMAKI") %$% 
  ts(catch.median, start = 2014, frequency = 1) 

reef.other = catch.stats %>% 
  filter(group == "Reef fish" & Zone == "OTHER") %$% 
  ts(catch.median, start = 2014, frequency = 1) 

## bind the ts together
 ts_c(Rumaki = reef.rumaki, Other = reef.other) %>% ts_plot()
 
ts_c(Rumaki = reef.rumaki, Other = reef.other) %>% ts_trend()

catch.clean.group.outlierfree %>% 
  filter(group == "Reef fish" & Zone == "RUMAKI") %$% 
  ts(catch, start = 2014, frequency = 12) 
```


<!--chapter:end:checki.Rmd-->

---
title: "generate report"
author: "Masumbuko Semba"
header-includes:
  - \usepackage{titling}
  # - \pretitle{\begin{center}\LARGE\includegraphics[width=15cm]{mahale_view.jpg}\\[\bigskipamount]}
  - \posttitle{\end{center}}
  - \usepackage{float}
  - \floatplacement{figure}{H}  ##make every figure with caption = h, this was the fix
  - \usepackage{fontspec}
  - \setmainfont{Adobe Caslon Pro} ## set fornt to Time New Roman
date: "1/21/2020"
output: 
      bookdown::pdf_document2:
        latex_engine: xelatex
        # includes:
        #   in_header: preamble.tex
        #   before_body: frontpage.tex
        #   after_body: endpage.tex
        # toc: true
        # toc_depth: 2
        # number_sections: true
        # fig_caption: yes
        # keep_tex: yes
indent: false
toc: false
lof: true
lot: true
fontsize: 12pt
linestretch: 1.2
# geometry: "left=4cm, right=2.5cm, top=2.5cm, bottom=2.5cm"
# bibliography: mahale.bib
# csl: elsevier.csl
link-citations: yes
# fig_width: 2.0
# fig_height: 2.0
# css: style.css
colorlinks: yes
editor_options: 
  chunk_output_type: console
---


## Activities proposed includes: 

i. Analyze CAS data collected from 2014 - 2018 and report trends in total catch, catch per unit effort, species composition and stock health 
i. Analyze catch in terms of species, size CPUE different between FISHCOM area and the rest of the area along the cost.
i. Assess any reappearance of fish species in the study area and its link to conservation
i. Assess any appearance of new fish species in the area and its link to conservation 
i. Identify gaps in the current statistical system and give recommendations on how to improve

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning=FALSE, message=FALSE, comment="")
# options(tinytex.verbose = TRUE)


```

```{r, include=FALSE}
require(tidyverse)
require(astsa)
require(ggpmisc)
require(ggfortify)
require(forecast)
require(kableExtra)
require(knitr)
```


```{r fig102, fig.cap="Total catch per location using raw data. Spot the outlier from all sites except Mtwara Rural"}
catch = readxl::read_excel(path = "All data combined.xlsx",sheet = 3, col_names = TRUE )

catch.clean = catch %>% 
  select(Location, Year, Month, Species,catch = 5)

catch.clean = catch.clean %>% 
  mutate(Month = replace(Month, Month == "Augast", "August"),
         Month = replace(Month, Month == "december", "December"),
         Month = replace(Month, Month == "september", "September"),
         Year = as.integer(Year)) %>%
  mutate(day = 15,
         Month = replace(Month, Month == "January", 1),
         Month = replace(Month, Month == "February", 2),
         Month = replace(Month, Month == "March", 3),
         Month = replace(Month, Month == "April", 4),
         Month = replace(Month, Month == "May", 5),
         Month = replace(Month, Month == "June", 6),
         Month = replace(Month, Month == "July", 7),
         Month = replace(Month, Month == "August", 8),
         Month = replace(Month, Month == "September", 9),
         Month = replace(Month, Month == "October", 10),
         Month = replace(Month, Month == "November", 11),
         Month = replace(Month, Month == "December", 12),
         Month = as.integer(Month),
         date = lubridate::make_date(year = Year, month = Month, day = day),
         catch =   catch %>% oce::despike())

catch.clean.group = catch.clean %>% 
  group_by(Location, date) %>% 
  summarise(catch = median(catch, na.rm = TRUE)) %>%
  ungroup() 

catch.clean.group  %>% ggplot(aes(x = Location, y = catch, fill = Location)) + 
  geom_boxplot(outlier.colour = "red", outlier.shape = 8, outlier.size = 3, alpha = .4)+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")
```


```{r}
## correct for outliers
q = quantile(catch.clean.group$catch, na.rm = TRUE)
iqr = IQR(catch.clean.group$catch, na.rm = TRUE)

lower = q[2] - 1.5*iqr
upper = q[4]+ 1.5*iqr
```

```{r fig1, fig.cap="Trend of raw catch data per each site"}
catch.clean.group = catch.clean.group %>% 
  arrange(date)

 now= catch.clean.group %>% 
   filter(catch > 250 & catch < 420) %>%
   mutate(mwezi = lubridate::month(date, abbr = TRUE, label = TRUE),
          year = lubridate::year(date) %>% as.integer(),
          label = paste(mwezi, ", ",year))

formula1 <- y ~ x

ggplot(data = catch.clean.group , 
       aes(x = date, y = catch, col = Location, fill = Location))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_date(date_minor_breaks = "1 month") +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Location, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")
# ggsave("fig1.pdf")
```

```{r fig101, fig.cap="Trend of error free catch data per each site"}

catch.clean.group.outlierfree = list()
sites = catch.clean.group %>% distinct(Location) %>% pull()

for (i in 1:length(sites)){
  
  dummy = catch.clean.group %>% filter(Location == sites[i])
    q = quantile(dummy$catch, na.rm = TRUE)
    iqr = IQR(dummy$catch, na.rm = TRUE) # alternative: iqr = q[4]-q[2]
    
    lower = q[2] - (1.5 * iqr)
    upper = q[4] + (1.5 * iqr)
    
 catch.clean.group.outlierfree[[i]] = dummy %>% 
   filter(catch > lower & catch <= upper)
  
}

catch.clean.group.outlierfree = catch.clean.group.outlierfree %>% bind_rows()

formula1 <- y ~ x

ggplot(data = catch.clean.group.outlierfree , 
       aes(x = date, y = catch, col = Location, fill = Location))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_date(date_minor_breaks = "2 year") +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Location, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")
```


```{r fig2, fig.cap="Trend of catch for all sites"}

catch.clean.group.wide = catch.clean.group %>% ungroup() %>% select(date, Location, catch) %>% pivot_wider(names_from = "Location", values_from = "catch") %>% arrange(date) 


ts.series = ts.intersect(
  Kibiti = ts(data = catch.clean.group.wide %>% pull(Kibiti),start = c(2016,6), frequency = 12),
  Kilwa = ts(data = catch.clean.group.wide %>% pull(Kilwa),start = c(2016,6), frequency = 12),
  Mafia = ts(data = catch.clean.group.wide %>% pull(Mafia),start = c(2016,6), frequency = 12),
  Mtwara = ts(data = catch.clean.group.wide %>% pull(`Mtwara Rural`),start = c(2016,6), frequency = 12),
  Kigamboni = ts(data = catch.clean.group.wide %>% pull(Kigamboni),start = c(2016,6), frequency = 12)
  ) 

ts.series %>% 
  autoplot() +  
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = c(.80,.75))+
  scale_y_continuous(breaks = seq(100,600,100))+
  labs(x = "", y = "Fish catch (Tonnes)")

# ggsave("fig2.pdf")
```



We notice that only the catch data has few missing values. Then we use it to represent the trend of cath. Because the data ends in september 2019, we extended for two more years and forecast the catches of fish in this site until september 2021. We add six months moving average on the plot
```{r fig3, fig.cap="Projected catch data beyond the collected period"}
ts.series[,2] %>% 
  window(start = c(2016,11)) %>%
  autoplot() +
  autolayer(snaive(y = ts.series[,2]%>% window(start = c(2018,1)), h = 24), 
            series = "Future Catch", PI = FALSE, showgap = FALSE)+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = c(.80,.75),)+
  scale_y_continuous(breaks = seq(100,600,100))+
  labs(x = "", y = "Fish catch (Tonnes)")+
  tidyquant::geom_ma(ma_fun = SMA,n=6, na.rm = TRUE) # for six moths moving average

```


```{r fig4, fig.cap="Species Composition at Mtwara"}
Mtwara = catch.clean %>% 
  group_by(Species, Location) %>% 
  tally() %>% 
  arrange(desc(n)) %>% ungroup() %>% 
  filter(Location == "Mtwara Rural") %>%
  separate(col = Species, into = c("Species", "others"), sep = " " )%>% 
  mutate(percentage = (n/sum(n) * 100) %>% round(2), cumsum = cumsum(percentage),
         labs = paste(percentage,"%")) %>%
  filter(percentage >= 5) 

kesho = Mtwara %>% bind_rows(
tibble(Species = "Others") %>%
  mutate(others = "Others",  Location = "Others", n = 89, percentage = 47.71, cumsum = NULL, labs = paste(percentage,"%"))) 

kesho%>% 
    ggpubr::ggdonutchart(x = "n", 
                       label = "labs", 
                       fill = "Species", color = "white", lab.pos = "in", lab.font = c(4, "bold", "ivory"))+
  # scale_fill_viridis_d() +
    scale_fill_brewer(palette = "Set3")+
  # ggsci::scale_color_jama() +
  theme(legend.position = "none")  +
    theme(legend.position = "right")
```

\newpage

```{r}
catch.districts = readxl::read_excel(path = "data_revised.xlsx",sheet = 2, col_names = TRUE ) %>% 
  select(year = 1, family = 2, english.name = 3, swahili.name = 4, district = 5, catch = 6, zone = 7) %>%
  mutate(year = as.integer(year), zone = as_factor(zone), english.name = as_factor(english.name), 
         swahili.name = as_factor(swahili.name), family = as_factor(family), district = as_factor(district),
         catch = as.numeric(catch))


```


```{r fig97, fig.cap="Catch comparison between Rumaki and other fishing areas. This figure is before removing outliers"}

catch.districts%>% 
  # filter(catch < 1000) %>%
  group_by(year, zone) %>% 
  summarise(n = n(),
            mean.catch = median(catch, na.rm = TRUE),
            sd = sd(catch, na.rm = TRUE),
            se = sd/sqrt(n)) %>%
  ungroup() %>% 
  ggplot(aes(x = year, y = mean.catch, col = zone)) +
  geom_line() +
  geom_point(size = 5)+
  geom_errorbar(aes(ymin = mean.catch-se, ymax = mean.catch+se), width = 0.075)+
  ggsci::scale_color_jco(name = "Fishing area", label = c("Non Rumaki", "Rumaki")) +
  scale_x_continuous(breaks = seq(2014,2016,1)) +
  scale_y_continuous(breaks = seq(0,95,15))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "right", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")

# catch.districts %>% filter(catch < 1000) %>% ggplot(aes(x = year, y = catch, col = zone)) + geom_point()
```

```{r}
## correct for outliers
q = quantile(catch.districts$catch, na.rm = TRUE)
iqr = IQR(catch.districts$catch, na.rm = TRUE)

lower = q[2] - 1.5*iqr
upper = q[4]+ 1.5*iqr
```

```{r fig99, fig.cap="Catch comparison between Rumaki and other fishing areas. This figure is after removing outliers"}

catch.districts%>% 
  # filter(catch < 1000) %>%
  filter(catch < upper) %>%
  group_by(year, zone) %>% 
  summarise(n = n(),
            mean.catch = median(catch, na.rm = TRUE),
            sd = sd(catch, na.rm = TRUE),
            se = sd/sqrt(n)) %>%
  ungroup() %>% 
  ggplot(aes(x = year, y = mean.catch, col = zone)) +
  geom_line() +
  geom_point(size = 5)+
  geom_errorbar(aes(ymin = mean.catch-se, ymax = mean.catch+se), width = 0.075)+
  ggsci::scale_color_jco(name = "Fishing area", label = c("Non Rumaki", "Rumaki")) +
  scale_x_continuous(breaks = seq(2014,2016,1)) +
  scale_y_continuous(breaks = seq(0,95,15))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "right", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")

# catch.districts %>% filter(catch < 1000) %>% ggplot(aes(x = year, y = catch, col = zone)) + geom_point()
```



```{r fig98, fig.cap="Common species caught in both Rumaki and other areas"}
catch.districts%>% 
  filter(catch > 50) %>%
  group_by(family, zone, year)  %>% 
  count() %>% ungroup() %>% 
  filter(family != "Others") %>%
  # arrange((english.name)) %>% 
  ggplot(aes(x = family, y = n, fill = zone)) + 
  geom_col(position = "dodge")+ 
  coord_flip()+ 
  facet_wrap(~year)+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"))+
  ggsci::scale_fill_jco(name = "Fishing area", label = c("Non Rumaki", "Rumaki"))+
  scale_y_continuous(breaks = seq(2,9,2)) +
  labs(x = "Family group", y = "Number of appearance")+
  theme(axis.text.y = element_text(size = 10))
  



```

\newpage

```{r}
catch.districts  %>%
  filter(english.name != "Others", catch > 300)  %>%
  group_by(english.name, zone, year)  %>%
  count() %>% ungroup() %>%
  pivot_wider(names_from = zone, values_from = n)%>%
  mutate(OTHER = replace(OTHER, !is.na(OTHER),"present"),
         OTHER = replace(OTHER, is.na(OTHER),"absent"),
         RUMAKI = replace(RUMAKI, !is.na(RUMAKI),"present"),
         RUMAKI = replace(RUMAKI, is.na(RUMAKI),"absent")) %>%
  filter(OTHER == "absent" & RUMAKI == "present") %>% pivot_wider(names_from = year, values_from = 3:4) %>%
  kableExtra::kable(format = "latex",booktabs = T,
                    caption = "Species found in Rumaki fishing area",
                    col.names = c("Species", "2015", "2016", "2015", "2016")) %>%
  kableExtra::add_header_above(c("", "Non Rumaki" = 2, "Rumaki" = 2)) %>%
  kableExtra::column_spec(column = 1, width = "5cm")%>%
  kableExtra::column_spec(column = 2:5, width = "2cm")
```


```{r}
catch.districts  %>%
  filter(english.name != "Others", catch > 300)  %>%
  group_by(english.name, zone, year)  %>%
  count() %>% ungroup() %>%
  pivot_wider(names_from = zone, values_from = n)%>%
  mutate(OTHER = replace(OTHER, !is.na(OTHER),"present"),
         OTHER = replace(OTHER, is.na(OTHER),"absent"),
         RUMAKI = replace(RUMAKI, !is.na(RUMAKI),"present"),
         RUMAKI = replace(RUMAKI, is.na(RUMAKI),"absent")) %>%
  filter(OTHER == "present" & RUMAKI == "absent") %>% pivot_wider(names_from = year, values_from = 3:4) %>%
  knitr::kable(format = "latex", booktabs = T,
               caption = "Species found in Non Rumaki fishing area",
               col.names = c("Species", "2015", "2016", "2015", "2016")) %>%
  kableExtra::add_header_above(c("", "Non Rumaki" = 2, "Rumaki" = 2))%>%
  kableExtra::column_spec(column = 1, width = "5cm")%>%
  kableExtra::column_spec(column = 2:5, width = "2cm")

```


```{r}
catch.districts  %>%
  filter(english.name != "Others", catch > 300)  %>%
  group_by(english.name, zone, year)  %>%
  count() %>% ungroup() %>%
  pivot_wider(names_from = zone, values_from = n)%>%
  mutate(OTHER = replace(OTHER, !is.na(OTHER),"present"),
         OTHER = replace(OTHER, is.na(OTHER),"absent"),
         RUMAKI = replace(RUMAKI, !is.na(RUMAKI),"present"),
         RUMAKI = replace(RUMAKI, is.na(RUMAKI),"absent")) %>%
  filter(OTHER == "present" & RUMAKI == "present") %>% pivot_wider(names_from = year, values_from = 3:4)  %>%
  knitr::kable(format = "latex",booktabs = T,
               caption = "Species found in Rumaki and Non-Rumaki fishing areas",
               col.names = c("Species", "2015", "2016", "2015", "2016")) %>%
  kableExtra::add_header_above(c("", "Non Rumaki" = 2, "Rumaki" = 2)) %>%
  kableExtra::column_spec(column = 1, width = "5cm")%>%
  kableExtra::column_spec(column = 2:5, width = "2cm")
```

<!--chapter:end:graphics.Rmd-->

---
title: "Fisheries performance in Rumaki and Non-Rumaki Areas"
author: 
- Baraka Kuguru
- Mathias Igulu
- Masumbuko Semba
header-includes:
  - \usepackage{titling}
  - \posttitle{\end{center}}
  - \usepackage{float}
  - \floatplacement{figure}{H}  ##make every figure with caption = h, this was the fix
  - \usepackage{fontspec}
  - \setmainfont{Adobe Caslon Pro} ## set fornt to Time New Roman
  - \usepackage{draftwatermark} ##add watermark to pdf output document
date: "2/10/2020"
output: 
      bookdown::pdf_document2:
        latex_engine: xelatex
        # includes:
        #   in_header: preamble.tex
        #   before_body: frontpage.tex
        #   after_body: endpage.tex
        toc: true
        toc_depth: 2
        # number_sections: true
        # fig_caption: yes
        # keep_tex: yes
indent: false
# toc: false
lof: true
lot: true
fontsize: 12pt
linestretch: 1.2
# geometry: "left=4cm, right=2.5cm, top=2.5cm, bottom=2.5cm"
# bibliography: mahale.bib
# csl: elsevier.csl
# link-citations: yes
# fig_width: 2.0
# fig_height: 2.0
css: report_style.css
colorlinks: yes

---


# Fisheries in Rumaki and Non-Rumaki Areas

```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, comment = FALSE)
```

```{r}
require(tidyverse)
require(ggpubr)
require(sf)
require(ggspatial)
```



```{r}
species = read_csv("./data_update/All data combined_cleaned.csv")

species = species %>% separate(Eng_name, c("Genus", "Species"), sep = " ", remove = FALSE)

# species %>% distinct(Genus) %>% arrange(Genus)
```

```{r}

dominant.group = bind_rows(
      species%>%
        filter(Genus == "Lethrinus") %>%
        mutate(group = "Reef fish"),
      
      species%>%
        filter(Genus %in% c("Euthynus", "Scomberomorus", "Thunnus", "Tuna", "Xiphias ")) %>%
        mutate(group = "Tuna fish"),
      
      species%>%
        filter(Genus == "Octopus") %>%
        mutate(group = "Octopus"),
      
      species%>%
        filter(Genus %in% c("Mackerel", "Sardinella")) %>%
        mutate(group = "Small pelagic")
) %>%
  mutate(catch = as.numeric(`Catch(t)`))


```




```{r fig101, fig.cap="Trend of error free catch data per each site"}

catch.clean.group.outlierfree = list()
sites = dominant.group %>% distinct(Districts) %>% pull()

for (i in 1:length(sites)){
  
  dummy = dominant.group %>% filter(Districts == sites[i])
    q = quantile(dummy$catch, na.rm = TRUE)
    iqr = IQR(dummy$catch, na.rm = TRUE) # alternative: iqr = q[4]-q[2]
    
    lower = q[2] - (1.5 * iqr)
    upper = q[4] + (1.5 * iqr)
    
 catch.clean.group.outlierfree[[i]] = dummy %>% 
   filter(catch > lower & catch <= upper)
  
}

catch.clean.group.outlierfree = catch.clean.group.outlierfree %>% 
  bind_rows() %>%
  mutate(Districts = replace(Districts, Districts=="Kindondoni", "Kinondoni"),
         Districts = replace(Districts, Districts=="Lindi urban","Lindi Urban"),
         Districts = replace(Districts, Districts=="Lindi", "Lindi Urban"),
         Districts = replace(Districts, Districts=="Mtwara", "Mtwara Urban"),
         Districts = replace(Districts, Districts=="Kibiti", "Rufiji"))


```

```{r}
tz = st_read("e:/GIS/tanzania-latest.shp/nbs/Districts.shp", quiet = TRUE )


```

```{r}
rumaki.districts = catch.clean.group.outlierfree %>% distinct(Districts) %>% pull()
rumaki.districts[3] = "Tanga Urban"
rumaki.districts[16] = "Lindi"

coastal = tz %>% filter(District_N %in% rumaki.districts)

coastal %>% mapview::mapview()

catch.clean.join = catch.clean.group.outlierfree %>% 
  # filter(group == "Reef fish") %>% 
  mutate(Districts = replace(Districts, Districts == "Kigamboni", "Temeke"),
         Districts = replace(Districts, Districts == "Kibiti", "Mafia"), 
         Districts = replace(Districts, Districts == "Lindi Rural", "Lindi"),
         Districts = replace(Districts, Districts == "Mtwara Rural", "Mtwara")) %>%
  group_by(Districts, Zone, group) %>% summarise(catch = mean(catch, na.rm = TRUE)) %>%
  ungroup()


catch.clean.join.spatial = coastal %>% 
  rename(Districts = District_N)  %>% 
  full_join(catch.clean.join) %>%
  mutate(class = cut(catch, breaks = seq(0,400,75), 
                     labels = c("Below 75", "75-150", "150-225", "225-300", "above 300")))

 
```


```{r}
coordinates = catch.clean.join.spatial %>% 
                  # filter(Zone == "OTHER" & group == "Tuna fish") %>%
  select(Districts, group) %>% 
  st_centroid() %>% 
  st_coordinates() %>% 
  as_tibble() %>% 
  rename(lon = 1, lat = 2) %>%
  bind_cols(
    catch.clean.join.spatial %>% 
      # filter(Zone == "OTHER" & group == "Tuna fish") %>%
      select(Districts, group) %>% st_drop_geometry()
  )


```

```{r, eval=FALSE}
ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% filter(Zone == "OTHER")%>% 
                  st_simplify(dTolerance = .015),
                aes(fill = class), col = NA)+
   # ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6), 
   #                          aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  facet_wrap(~group, nrow = 1) +
  ggsci::scale_fill_locuszoom() +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
   cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "right", 
        legend.key.width = unit(.5,"cm"))
```

## Spatial catch variation in Non Rumaki

```{r fig3, fig.cap="Octopus catch variation over Non-Rumaki Area"}

ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  filter(Zone == "OTHER" & group == "Octopus") %>% 
                  st_simplify(dTolerance = 0),
          aes(fill = class), col = "ivory") +
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6 & group == "Octopus"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .75)+
  labs(x = "", y = "")

# ggsave("fig1.png", dpi = 650)
```

```{r fig4, fig.cap="Tuna fish catch variation over Non-Rumaki Area"}

ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  filter(Zone == "OTHER" & group == "Tuna fish") %>% 
                  st_simplify(dTolerance = 0),
          aes(fill = class), col = "ivory") +
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6 & group == "Tuna fish"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .75)+
  labs(x = "", y = "")

# ggsave("fig2.png", dpi = 650)
```

```{r fig5, fig.cap="Small pelagic catch variation over Non-Rumaki Area"}

ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  filter(Zone == "OTHER" & group == "Small pelagic") %>% 
                  st_simplify(dTolerance = 0),
          aes(fill = class), col = "ivory") +
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6 & group == "Small pelagic"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .75)+
  labs(x = "", y = "")

# ggsave("fig3.png", dpi = 650)
```

```{r fig6, fig.cap="Reef fish catch variation over Non-Rumaki Area"}
ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  filter(Zone == "OTHER" & group == "Reef fish") %>% 
                  st_simplify(dTolerance = 0),
          aes(fill = class), col = "ivory") +
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6 & group == "Reef fish"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .75)+
  labs(x = "", y = "")

# ggsave("fig4.png", dpi = 650)
```

## Spatial catch variation in Rumaki

```{r fig7, fig.cap="Octopus catch variation accross Rumaki Area"}

 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% na.omit() %>% filter(group == "Octopus"),
          aes(fill = class), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat <= -7.6 & group == "Octopus"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-7.5), crs = 4326)+
  ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")
 
 # ggsave("fig5.png", dpi = 650)

```


```{r fig8, fig.cap="Reef fish catch variation accross Rumaki Area"}
 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% na.omit() %>% filter(group == "Reef fish"),
          aes(fill = class), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat <= -7.6 & group == "Reef fish"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-7.5), crs = 4326)+
  ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")

# ggsave("fig6.png", dpi = 650)
```


```{r fig9, fig.cap="Tuna catch variation accross Rumaki Area"}
 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% na.omit() %>% filter(group == "Tuna fish"),
          aes(fill = class), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat <= -7.6 & group == "Tuna fish"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-7.5), crs = 4326)+
  ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")

# ggsave("fig7.png", dpi = 650)

```


```{r fig10, fig.cap="Small pelagic catch variation accross Rumaki Area"}
 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% na.omit() %>% filter(group == "Small pelagic"),
          aes(fill = class), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% filter(lat <= -7.6 & group == "Small pelagic"), 
                            aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-7.5), crs = 4326)+
  ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")

# ggsave("fig8.png", dpi = 650)

```


## Regression and correlation of annual fish catches over study period

```{r fig11, fig.cap="District in Rumaki areas with relatively stable annual catches", fig.height=3.5, fig.width=3.5}


formula1 <- y ~ x

ggplot(data = catch.clean.group.outlierfree %>% filter(Zone == "RUMAKI" & Districts %in% c("Rufiji", "Mafia")) , 
       aes(x = Year, y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(2015,2017)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts)+
  labs(x = "", y = "Fish catch (Tonnes)")

# ggsave("fig9.png", dpi = 650)

```


```{r fig12, fig.cap="District in Rumaki areas with relatively decline annual catches", fig.width=6, fig.height=4}

ggplot(data = catch.clean.group.outlierfree %>% filter(Zone == "RUMAKI" & !Districts %in% c("Rufiji", "Mafia")) , 
       aes(x = Year, y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(2015,2017)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")

# ggsave("fig10.png", dpi = 650)
```



```{r fig13, fig.cap="District in Non-Rumaki areas with relatively decline annual catches", fig.width=6, fig.height=4}


formula1 <- y ~ x

ggplot(data = catch.clean.group.outlierfree %>% 
         filter(Zone == "OTHER" & 
                  Districts %in% c("Ilala", "Pangani", "Tanga", "Temeke", "Lindi Urban")) , 
       aes(x = Year, y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(2015,2017)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")

# ggsave("fig11.png", dpi = 650)
```


```{r fig14, fig.cap="District in Non-Rumaki areas with relatively stable annual catches", fig.width=6, fig.height=4}

ggplot(data = catch.clean.group.outlierfree %>% 
         filter(Zone == "OTHER" & 
                  !Districts %in% c("Ilala", "Pangani", "Tanga", "Temeke", "Lindi Urban")) , 
       aes(x = Year, y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(2015,2017)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")

# ggsave("fig12.png", dpi = 650)
```


## Catches of common fish groups


```{r fig15, fig.cap="Catches of four common fish group in Rumaki and Non-Rumaki area"}
catch.clean.group.outlierfree %>%
  ggplot(aes(x = Year %>% as_factor(), y = catch, fill = Zone, col = Zone))+
  geom_boxplot(alpha = .4)+
  facet_wrap(~group)+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "bottom")+
  labs(x = "", y = "Fish catch (Tonnes)")+
  scale_fill_discrete(name = "")+
  scale_color_discrete(name = "")

# ggsave("fig13.png", dpi = 650)
```

```{r fig16, fig.cap="Catches pooled for the four common fish group in Rumaki and Non-Rumaki area", fig.height=3.5, fig.width=4}
catch.zone = catch.clean.group.outlierfree %>% group_by(Year,Zone) %>% 
  summarise(n = n(),
            catch.mean = mean(catch, na.rm = TRUE),
            catch.median = median(catch, na.rm = TRUE),
            catch.sd = sd(catch, na.rm = TRUE),
            catch.se = catch.sd/sqrt(n)) %>%
  ungroup() 

catch.zone %>% 
  ggplot(aes(x = Year, y = catch.median, col = Zone)) +
  geom_line() +
  geom_errorbar(aes(ymin = catch.median - catch.se, 
                    ymax = catch.median + catch.se), width = 0.075)+
  geom_point(size = 3)+
  # facet_wrap(~group, strip.position = "top" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = c(.4,.9), 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")+
   ggsci::scale_color_d3(name = "")

# ggsave("fig14.png", dpi = 650)

```


```{r fig17, fig.cap="Mean Catches and standard error for the four common fish group in Rumaki and Non-Rumaki area", fig.width=5, fig.height=4}
catch.stats = catch.clean.group.outlierfree %>% group_by(Year,Zone, group) %>% 
  summarise(n = n(),
            catch.mean = mean(catch, na.rm = TRUE),
            catch.median = median(catch, na.rm = TRUE),
            catch.sd = sd(catch, na.rm = TRUE),
            catch.se = catch.sd/sqrt(n)) %>%
  ungroup() 


catch.stats %>% 
  ggplot(aes(x = Year, y = catch.median, col = Zone)) +
  geom_line() +
  geom_errorbar(aes(ymin = catch.median - catch.se, 
                    ymax = catch.median + catch.se), width = 0.075)+  
  geom_point(size = 3)+
  facet_wrap(~group, strip.position = "top" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "bottom", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")+
   ggsci::scale_color_d3(name = "")+
  scale_x_continuous(breaks = 2014:2017)

# ggsave("fig15.png", dpi = 650)

```

```{r fig18, fig.cap="Reef fish catches in Rumaki and Non-Rumaki area", fig.width=4.5, fig.height=3.5}

 
 catch.stats %>% filter(group == "Reef fish") %>%
  ggplot(aes(x = Year, y = catch.median, col = Zone)) +
  geom_line() +
    geom_errorbar(aes(ymin = catch.median - catch.se, 
                    ymax = catch.median + catch.se), width = 0.075)+
  geom_point(size = 4)+
  # facet_wrap(~group, strip.position = "top" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = c(.5,.8), 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")+
   ggsci::scale_color_d3(name = "")

# ggsave("fig16.png", dpi = 650)
```


## Rate of Change in Catches

```{r fig19, fig.cap="Catches anomaly using the 2018 catches as reference for Rumaki and Non-Rumaki area", fig.width=6, fig.height=4}
## compute the lead anomaly use 2018 catches as reference value
lead.others = catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>% 
  mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  arrange(date, zone) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  filter(zone == "OTHER")%>%
  mutate(octopus.lead = Octopus - lead(Octopus),
         reef.lead = `Reef fish` - lead(`Reef fish`),
         pelagic.lead = `Small pelagic` - lead(`Small pelagic`),
         tuna.lead = `Tuna fish` - lead(`Tuna fish`)) %>%
  select(date, year, zone, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead) %>%
  pivot_longer(cols = 4:7, names_to = "group") 

lead.rumaki = catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>% 
  mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  arrange(date, zone) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  filter(zone == "RUMAKI")%>%
  mutate(octopus.lead = Octopus - lead(Octopus),
         reef.lead = `Reef fish` - lead(`Reef fish`),
         pelagic.lead = `Small pelagic` - lead(`Small pelagic`),
         tuna.lead = `Tuna fish` - lead(`Tuna fish`)) %>%
  select(date, year, zone, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead) %>%
  pivot_longer(cols = 4:7, names_to = "group")

lead.catch.anomaly = lead.others %>%
  bind_rows(lead.rumaki)

lead.catch.anomaly %>% 
  ggplot(aes(x = year, y = value, col = zone)) +
  geom_line() +
  geom_point(size = 3)+
  facet_wrap(~group, strip.position = NULL , scales = "free_y")+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "bottom", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Catch anomaly (Tonnes)")+
   ggsci::scale_color_d3(name = "")

# ggsave("fig17.png", dpi = 650)
```



```{r fig20, fig.cap="Rate of change of catches in percentage for Rumaki and Non-Rumaki area", fig.width=6, fig.height=4}

## rate of change in percentage of catch

percentage.others = catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>% 
  mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  arrange(date, zone) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  filter(zone == "OTHER")%>%
  mutate(octopus.lead = Octopus/sum(Octopus)*100,
         reef.lead = `Reef fish`/sum(`Reef fish`)*100,
         pelagic.lead = `Small pelagic`/sum(`Small pelagic`)*100,
         tuna.lead = `Tuna fish`/sum(`Tuna fish`)*100) %>%
  select(date, year, zone, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead) %>%
  pivot_longer(cols = 4:7, names_to = "group") 



percentage.rumaki = catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>% 
  mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  arrange(date, zone) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  filter(zone == "RUMAKI")%>%
  mutate(octopus.lead = Octopus/sum(Octopus)*100,
         reef.lead = `Reef fish`/sum(`Reef fish`)*100,
         pelagic.lead = `Small pelagic`/sum(`Small pelagic`)*100,
         tuna.lead = `Tuna fish`/sum(`Tuna fish`)*100) %>%
  select(date, year, zone, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead) %>%
  pivot_longer(cols = 4:7, names_to = "group")

catch.percentage = percentage.others %>%
  bind_rows(percentage.rumaki)

catch.percentage %>% 
  ggplot(aes(x = year, y = value, col = zone)) +
  geom_line() +
  geom_point(size = 3)+
  facet_wrap(~group, strip.position = NULL )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "bottom", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Catch Rate (%)")+
   ggsci::scale_color_d3(name = "")+
  scale_x_continuous(breaks = 2014:2017)

# ggsave("fig18.png", dpi = 650)
```



```{r}
catch.stats %>% select(year = Year, zone = Zone, group, catch.median) %>% 
  spread(key = group, value = catch.median) %>%
  kableExtra::kable(format = "latex", caption = "Annual mean averages of common fish groups",
                    digits = 2, align = "c", booktabs = TRUE,
                    col.names = c("Year", "Area", "Octopus", "Reef", "Pelagic", "Tuna")) %>%
  kableExtra::column_spec(column = 1, width = "2cm") %>% 
  kableExtra::column_spec(column = 2:6, width = "2.5cm") %>%
  kableExtra::add_header_above(c("", "", "Fish catches (Tonnes)" = 4))

```


```{r, eval=FALSE}
require(tsbox)

reef.rumaki = catch.stats %>% 
  filter(group == "Reef fish" & Zone == "RUMAKI") %$% 
  ts(catch.median, start = 2014, frequency = 1) 

reef.other = catch.stats %>% 
  filter(group == "Reef fish" & Zone == "OTHER") %$% 
  ts(catch.median, start = 2014, frequency = 1) 

## bind the ts together
 ts_c(Rumaki = reef.rumaki, Other = reef.other) %>% ts_plot()
 
ts_c(Rumaki = reef.rumaki, Other = reef.other) %>% ts_trend()

catch.clean.group.outlierfree %>% 
  filter(group == "Reef fish" & Zone == "RUMAKI") %$% 
  ts(catch, start = 2014, frequency = 12) 
```


## catch composition
```{r}
species.groups = catch.clean.group.outlierfree %>% 
  filter(Zone == "RUMAKI") %>% 
  group_by(Districts, group) %>% 
  summarise(weight = mean(catch, na.rm = TRUE)) %>% 
  ungroup() %>%
  rename(Location = Districts)


ggpubr::ggarrange(
  species.groups %>%
  filter(Location == "Kilwa")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%"))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "none")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Kilwa")
  ,
  
    species.groups %>%
  filter(Location == "Mafia")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "right")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Mafia"),
  nrow = 1, common.legend = TRUE, legend = "right")

#ggsave(filename = "ecatch_composition_kilwa_mafia.png", dpi = 600)

```



```{r}

ggpubr::ggarrange(

 species.groups %>%
  filter(Location == "Mtwara Rural")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%"))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "none")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Mtwara Rural"),
  
  
   species.groups %>%
  filter(Location == "Mtwara Urban")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%"))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "right")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Mtwara Urban"),
  
 nrow = 1, common.legend = TRUE, legend = "right"
  )

#ggsave(filename = "catch_composition_mtwaras.png", dpi = 600)
```



```{r}

ggpubr::ggarrange(

 species.groups %>%
  filter(Location == "Kigamboni")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%"))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "none")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Temeke"),
  
  
   species.groups %>%
  filter(Location == "Rufiji")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%"))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "right")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Rufiji"),
  
 nrow = 1, common.legend = TRUE, legend = "right"
  )

#ggsave(filename = "catch_composition_temeke_rufiji.png", dpi = 600)
```

<!--chapter:end:reanalaysis.Rmd-->

---
title: "Fisheries performance in Rumaki and Non-Rumaki Areas"
author: 
- Baraka Kuguru
- Mathias Igulu
- Masumbuko Semba
# date: "3/16/2020"
header-includes:
  - \usepackage{titling}
  - \posttitle{\end{center}}
  - \usepackage{float}
  - \floatplacement{figure}{H}  ##make every figure with caption = h, this was the fix
  - \usepackage{fontspec}
  - \setmainfont{Adobe Caslon Pro} ## set fornt to Time New Roman
output: 
      bookdown::pdf_document2:
        latex_engine: xelatex
        # includes:
        #   in_header: preamble.tex
        #   before_body: frontpage.tex
        #   after_body: endpage.tex
        toc: true
        toc_depth: 2
        # number_sections: true
        # fig_caption: yes
        # keep_tex: yes
indent: false
# toc: false
lof: true
lot: true
fontsize: 12pt
linestretch: 1.2
# geometry: "left=4cm, right=2.5cm, top=2.5cm, bottom=2.5cm"
# bibliography: mahale.bib
# csl: elsevier.csl
# link-citations: yes
# fig_width: 2.0
# fig_height: 2.0
css: report_style.css
colorlinks: yes
editor_options: 
  chunk_output_type: console
delete_merged_file = true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, comment = "")

require(tidyverse)
require(ggpubr)
require(sf)
require(ggspatial)
```

# Fisheries in Rumaki Areas

```{r}
species = read_csv("./data_update/rumakitu.csv") 

species = species %>% select(1:5)


# species = species %>% 
  # separate(Species, c("Genus", "Species"), sep = " ", remove = FALSE)

# species %>% distinct(Species) %>% arrange(Species)
```

```{r}

dominant.group = bind_rows(
      species%>%
        filter(Species %in% c("Serranidae spp( CEW )","Lutjanus spp( LDW )", "Lutjanus ssp( LTJ )","Red snapper( RDS )","Changu( CHN )", "Carrotomus carolinus( ULG )","Lethrinus borbonicus( LHB )", "Lethrinus harak( LHH )", "Lethrinus lentjan( LHL )", "Lethrinus nebulosus( LHN )", "Lethrinus rubrioperculatus( LHR )", "Lethrinus spp( LH )")) %>%
        mutate(group = "Reef fish"),
      
      species%>%
        filter(Species %in% c("Auxis thazard( FRI )", "Euthynnus affinis( KAW )", "Istiophorus platypterus( SFA )", "Katsuwonus pelamis( SKJ )", "Other tuna( JDR )", "Scomberomorus commerson( COM )", "Scomberomorus guttatus( GUT )", "Scomberomorus plurilineatus( KAK )", "Thunnus albacares( YFT )", "Thunnus obesus( BET )", "Tuna( NGR )")) %>%
        mutate(group = "Tuna fish"),
      
      species%>%
        filter(Species == "Octopus cyanea( OCC )") %>%
        mutate(group = "Octopus"),
      species %>% 
  filter(Species %in% c("Aetobatus ocellatus( MAE )", "Carcharhinus albimarginatus( ALS )", "Carcharhinus plumbeus( CCP )", "Carcharhinus sorrah( CCQ )", "Himantura uarnak( DHV )", "Maculabatis ambigua( RAJ )", "Manta alfredi( TNG )", "Rhynchobatus sp.( RCD )", "Taa( NYG )", "Taa( NYG )", "Papa mavongoroa( PMV )", "Papa( PP )"))%>%
        mutate(group = "Elasmobranch"),
      
      species%>%
        filter(Species %in% c("Mackerel(scomber)( KB )", "Mackerel(scomber)( VB )", "Sardine( DA )","Sardine( DA )" ,"Dagaa ( DPP )","Dagaa ( DPP )", "Amblygaster sirm( AMS )", "Decapterus russelli( RUS )", "Dussumieria acuta( DSA )")) %>%
        mutate(group = "Small pelagic")
) %>%
  rename(catch = 5)


```

```{r}
species.groups = dominant.group %>% 
  group_by(group, Location) %>% 
  summarise(weight = mean(catch, na.rm = TRUE)) %>% 
  ungroup() 


ggpubr::ggarrange(
  species.groups %>%
  filter(Location == "Kigamboni")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%"))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "none")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Temeke")
  ,
  
    species.groups %>%
  filter(Location == "Kilwa")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "right")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Kilwa"),
  nrow = 1, common.legend = TRUE, legend = "right")

# ggsave(filename = "ecas_catch_composition_temeke_kilwa.png", dpi = 600)
```


```{r}

ggpubr::ggarrange(

 species.groups %>%
  filter(Location == "Mtwara Rural")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%"))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "none")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Mtwara Rural"),
  
  
   species.groups %>%
  filter(Location == "Mafia")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%"))%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "right")+
  # scale_fill_viridis_d()+
  ggsci::scale_fill_jama(name = "Dominant\nFish Groups") +  
  labs(subtitle = "Mafia"),
  
 nrow = 1, common.legend = TRUE, legend = "right"
  )

#ggsave(filename = "ecas_catch_composition_mtwara_mafia.png", dpi = 600)
```


```{r}

  species.groups %>%
  filter(Location == "Kibiti")%>%
  mutate(percentage = (weight/sum(weight)*100) %>% round(digits = 1),
         labs = paste(percentage, "%")) %>%
    arrange(group)%>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "percentage",
                       fill = "group", color = "white", lab.pos = "in")+
  theme(legend.position = "right")+
  # scale_fill_viridis_d()+
  # ggsci::scale_fill_jama(name = "Dominant\nFish Groups") + 
  scale_fill_manual(values = c("#374E55", "#00A1D5"),name = "Dominant\nFish Groups")+
  labs(subtitle = "Rufiji")

#ggsave(filename = "ecas_catch_composition_rufiji.png", dpi = 600)

```



```{r fig101, fig.cap="Trend of error free catch data per each site"}

catch.clean.group.outlierfree = list()
sites = dominant.group %>% distinct(Location) %>% pull()

for (i in 1:length(sites)){
  
  dummy = dominant.group %>% filter(Location == sites[i])
    q = quantile(dummy$catch, na.rm = TRUE)
    iqr = IQR(dummy$catch, na.rm = TRUE) # alternative: iqr = q[4]-q[2]
    
    lower = q[2] - (1.5 * iqr)
    upper = q[4] + (1.5 * iqr)
    
 catch.clean.group.outlierfree[[i]] = dummy %>% 
   filter(catch > lower & catch <= upper)
  
}

catch.clean.group.outlierfree = catch.clean.group.outlierfree %>% 
  bind_rows() 


```


```{r}
tz = st_read("e:/GIS/tanzania-latest.shp/nbs/Districts.shp", quiet = TRUE )

# tz %>% arrange(District_N) %>% pull(District_N)
```

```{r}

catch.clean.join = catch.clean.group.outlierfree %>% 
  # filter(group == "Reef fish") %>% 
  mutate(Location = replace(Location, Location == "Kigamboni", "Temeke"),
         Location = replace(Location, Location == "Kibiti", "Rufiji"), 
         Location = replace(Location, Location == "Lindi Rural", "Lindi"),
         Location = replace(Location, Location == "Mtwara Rural", "Mtwara")) %>%
  group_by(Location, group) %>% summarise(catch = mean(catch, na.rm = TRUE)) %>%
  ungroup() %>%
  rename(District = Location)


rumaki.districts = catch.clean.join %>% distinct(District) %>% pull()


coastal = tz %>% filter(District_N %in% rumaki.districts)

# coastal %>% mapview::mapview()



catch.clean.join.spatial = coastal %>% 
  rename(District = District_N)  %>% 
  full_join(catch.clean.join, by = c("District")) %>%
  mutate(catch = round(catch, digits = 2),class = cut(catch, breaks = seq(0,400,75), 
                     labels = c("Below 75", "75-150", "150-225", "225-300", "above 300")))

 
```


```{r}
coordinates = catch.clean.join.spatial %>% 
                  # filter(Zone == "OTHER" & group == "Tuna fish") %>%
  select(District, group) %>% 
  st_centroid() %>% 
  st_coordinates() %>% 
  as_tibble() %>% 
  rename(lon = 1, lat = 2) %>%
  bind_cols(
    catch.clean.join.spatial %>% 
      # filter(Zone == "OTHER" & group == "Tuna fish") %>%
      select(District, group) %>% st_drop_geometry()
  )


```

```{r, eval=FALSE}
ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% filter(Zone == "OTHER")%>% 
                  st_simplify(dTolerance = .015),
                aes(fill = class), col = NA)+
   # ggrepel::geom_label_repel(data = coordinates %>% filter(lat >= -7.6), 
   #                          aes(x = lon, y = lat, label = Districts),point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40), ylim = c(-7.6,-4.5), crs = 4326)+
  facet_wrap(~group, nrow = 1) +
  ggsci::scale_fill_locuszoom() +
  scale_x_continuous(breaks = c(38.1,39.7))+
  scale_y_continuous(breaks = c(-7.25,-4.75)) +
   cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "right", 
        legend.key.width = unit(.5,"cm"))
```


## Spatial catch variation in Rumaki

```{r fig1, fig.cap="Octopus catch variation accross Rumaki Area"}

 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  drop_na() %>% filter(group == "Octopus"),
          aes(fill = catch %>%as.factor()), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% 
                              filter(lat <= -6.0 & group == "Octopus"), 
                            aes(x = lon, y = lat, label = District),
                            point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-6.0), crs = 4326)+
  # ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")
 
 # ggsave("octopus.png", dpi = 650)

```



```{r fig2, fig.cap="Reef fish catch variation accross Rumaki Area"}

 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  drop_na() %>% filter(group == "Reef fish"),
          aes(fill = catch %>%as.factor()), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% 
                              filter(lat <= -6 & group == "Octopus"), 
                            aes(x = lon, y = lat, label = District),
                            point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-6.5), crs = 4326)+
  # ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")
 
 # ggsave("reefFish.png", dpi = 650)

```



```{r fig3, fig.cap="Elasmobrach catch variation accross Rumaki Area"}

 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  drop_na() %>% filter(group == "Elasmobranch"),
          aes(fill = catch %>%as.factor()), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% 
                              filter(lat <= -6 & group == "Octopus"), 
                            aes(x = lon, y = lat, label = District),
                            point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-6.5), crs = 4326)+
  # ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")
 
 # ggsave("elasmobracnch.png", dpi = 650)

```


```{r fig104, fig.cap="Small pelagic catch variation accross Rumaki Area"}

 ggplot() +
  layer_spatial(data = catch.clean.join.spatial %>% 
                  drop_na() %>% filter(group == "Small pelagic"),
          aes(fill = catch %>%as.factor()), col = "ivory")+
  ggrepel::geom_label_repel(data = coordinates %>% 
                              filter(lat <= -6 & group == "Octopus"), 
                            aes(x = lon, y = lat, label = District),
                            point.padding = 2.2) +
  coord_sf(xlim = c(37.5,40.5), ylim = c(-11.1,-6.5), crs = 4326)+
  # ggsci::scale_fill_locuszoom() +
  ggsci::scale_fill_locuszoom(name = "Catch \n(Tonnes)") +
  scale_y_continuous(breaks = c(-10.5,-8.25)) +
  scale_x_continuous(breaks = c(38.2,39.85))+
  cowplot::theme_minimal_grid() +
  theme(panel.grid = element_line(linetype = 3))+
  ggspatial::annotation_scale(position = "bl", bar_cols = c("grey", "ivory"), text_cex = .85)+
  labs(x = "", y = "")
 
 # ggsave("pelagic.png", dpi = 650)



```

```{r}
catch.clean.group.outlierfree = catch.clean.group.outlierfree %>% rename(Districts = Location)

catch.clean.group.outlierfree = catch.clean.group.outlierfree %>%
  mutate(Month = replace(Month, Month== "January",1),
         Month = replace(Month, Month== "February",2),
         Month = replace(Month, Month== "March",3),
         Month = replace(Month, Month== "April",4),
         Month = replace(Month, Month== "May",5),
         Month = replace(Month, Month== "June",6),
         Month = replace(Month, Month== "July",7),
         Month = replace(Month, Month== "August",8),
         Month = replace(Month, Month== "Augast",8),
         Month = replace(Month, Month== "September",9),
         Month = replace(Month, Month== "september",9),
         Month = replace(Month, Month== "October",10),
         Month = replace(Month, Month== "November",11),
         Month = replace(Month, Month== "December",12),
         Month = replace(Month, Month== "december",12),
         Month = Month %>% as.integer(),
         Day = 14, 
         date = lubridate::make_date(year = Year, month = Month, day = Day))

# catch.clean.group.outlierfree %>% distinct(Month)
```


## Regression and correlation of annual fish catches over study period

```{r fig11, fig.cap="District in Rumaki areas with relatively stable annual catches"}


formula1 <- y ~ x

ggplot(data = catch.clean.group.outlierfree , 
       aes(x = date %>%as.numeric() , y = catch, col = Districts, fill = Districts))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # ggpmisc::stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  ggpmisc::stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_continuous(breaks = c(17200,17600,18000),labels =  c(2017,2018,2019)) +
  # scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Districts)+
  labs(x = "", y = "Fish catch (Tonnes)")

# ggsave("trends.png", dpi = 650)

```


## Catches of common fish groups


```{r fig15, fig.cap="Catches of four common fish group in Rumaki area", fig.height=3.5, fig.width=8}
catch.clean.group.outlierfree %>%
  ggplot(aes(x = Year %>% as_factor(), y = catch, fill = Districts, col = Districts))+
  geom_boxplot(alpha = .4)+
  facet_wrap(~group, scales = "free_y")+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "bottom")+
  labs(x = "", y = "Fish catch (Tonnes)")+
  scale_fill_discrete(name = "")+
  scale_color_discrete(name = "")

# ggsave("catch_site_years.png", dpi = 650)
```


```{r fig16, fig.cap="Catches pooled for the four common fish group in Rumaki area"}
catch.zone = catch.clean.group.outlierfree %>% group_by(Year, group) %>% 
  summarise(n = n(),
            catch.mean = mean(catch, na.rm = TRUE),
            catch.median = median(catch, na.rm = TRUE),
            catch.sd = sd(catch, na.rm = TRUE),
            catch.se = catch.sd/sqrt(n)) %>%
  ungroup() 

catch.zone %>% 
  ggplot(aes(x = Year, y = catch.median,col = group)) +
  geom_line() +
  geom_errorbar(aes(ymin = catch.median - catch.se, 
                    ymax = catch.median + catch.se), width = 0.075)+
  geom_point(size = 3)+
  # facet_wrap(~group, strip.position = "top" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "none", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")+
   ggsci::scale_color_d3(name = "")+
  facet_wrap(~group, scales = "free_y")

# ggsave("catch_site_year_group.png", dpi = 650)

```

```{r fig17, fig.cap="Mean Catches and standard error for the four common fish group in Rumaki area"}

catch.stats = catch.clean.group.outlierfree %>% group_by(Year,Districts, group) %>% 
  summarise(n = n(),
            catch.mean = mean(catch, na.rm = TRUE),
            catch.median = median(catch, na.rm = TRUE),
            catch.sd = sd(catch, na.rm = TRUE),
            catch.se = catch.sd/sqrt(n)) %>%
  ungroup() 


catch.stats %>% 
  ggplot(aes(x = Year, y = catch.median, col = group)) +
  geom_line() +
  geom_errorbar(aes(ymin = catch.median - catch.se, 
                    ymax = catch.median + catch.se), width = 0.075)+  
  geom_point(size = 3)+
  facet_wrap(~Districts, strip.position = "top", scales = "free_y" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "right", 
        legend.key.width = unit(1.2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")+
   ggsci::scale_color_d3(name = "")+
  scale_x_continuous(breaks = 2016:2020)

ggsave("dominant_catch_site.png", dpi = 650)

```


```{r fig20, fig.cap="Rate of change of catches in percentage for Rumaki area"}


percentage.rumaki = catch.stats %>% select(year = Year, Districts, group, catch.median) %>% 
    mutate(day = 15, month = 6, date = lubridate::make_date(year, month, day)) %>%
  spread(key = group, value = catch.median) %>% 
  arrange(date) %>%
  select(-c(day, month)) %>%
  select(date, everything()) %>%
  # filter(zone == "RUMAKI")%>%
  mutate(octopus.lead = Octopus/sum(Octopus, na.rm = TRUE)*100,
         reef.lead = `Reef fish`/sum(`Reef fish`, na.rm = TRUE)*100,
         pelagic.lead = `Small pelagic`/sum(`Small pelagic`, na.rm = TRUE)*100,
         tuna.lead = `Tuna fish`/sum(`Tuna fish`, na.rm = TRUE)*100,
         elasmobranch = Elasmobranch/sum(Elasmobranch, na.rm = TRUE)*100) %>%
  select(date, year, Districts, Octopus = octopus.lead, Reef = reef.lead, 
         Pelagic = pelagic.lead, Tuna = tuna.lead, Elasmobranch = elasmobranch) %>%
  pivot_longer(cols = 4:8, names_to = "group")



percentage.rumaki %>% 
  ggplot(aes(x = year, y = value, col = group)) +
  geom_line() +
  geom_point(size = 3)+
  facet_wrap(~Districts, strip.position = NULL, scales = "free_y" )+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "bottom", 
        legend.key.width = unit(1.2,"cm"))+
  labs(x = "", y = "Catch Rate (%)")+
   ggsci::scale_color_d3(name = "")+
  scale_x_continuous(breaks = 2014:2020)

# ggsave("percentage_change.png", dpi = 650)
```




```{r}

catch.clean.group.season = catch.clean.group.outlierfree %>%
mutate(season = Month,
       season = replace(season, season %in% c(10,11,12,1,2,3), "NE"),
       season = replace(season, season %in% c(4,5,6,7,8,9), "SE"))

catch.clean.group.season %>%
  ggplot(aes(x = season, y = catch , fill = group))+
  geom_boxplot() +
  facet_wrap(~Districts, scales = "free_y")+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "right", 
        legend.key.width = unit(.5,"cm"))+
  labs(x = "", y = "Fish catches (Tonnes)")+
  ggsci::scale_fill_jama(name = "Dominant \nSpecies")

ggsave("seasonal_variation.png", dpi = 650)
```



## references


<!--chapter:end:reanalysis_rumaki_only.Rmd-->

---
title: "catch data"
author: "Mathias Msafiri Igulu"
date: "1/15/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

yoU can learn the usage of tidyverse package in detail in a book R for data science written by Hadley Wickham. You can access an online book, which is free at this [link](https://r4ds.had.co.nz/data-import.html)


We need to load the packages that contains function required for this processes. Use the `require()` function to load the packages in the session
```{r}
require(tidyverse)
require(astsa)
require(ggpmisc)
require(ggfortify)
require(forecast)
```

Our data is stored in Excel spreadsheet, and tidyverse packages lack the function to import or export excel file. However, there **readxl** package that contains tools to read and export files in Excell format.

```{r}

catch = readxl::read_excel(path = "data_revised.xlsx",sheet = 1, col_names = TRUE )
```

we noticed that column 6 and 7 have been renamed, but we know these columns data were removed from the files. therefore, we also need to trim them off from the dataset.
```{r}
catch.clean = catch %>% 
  select(Location, Year, Month, Species,catch = 5)
```

trend in fish catch
Clean months with typos to correct Month names
```{r}
# catch.clean %>% group_by(Month) %>% tally()

catch.clean = catch.clean %>% 
  mutate(Month = replace(Month, Month == "Augast", "August"),
         Month = replace(Month, Month == "december", "December"),
         Month = replace(Month, Month == "september", "September"),
         Year = as.integer(Year)) %>%
  mutate(day = 15,
         Month = replace(Month, Month == "January", 1),
         Month = replace(Month, Month == "February", 2),
         Month = replace(Month, Month == "March", 3),
         Month = replace(Month, Month == "April", 4),
         Month = replace(Month, Month == "May", 5),
         Month = replace(Month, Month == "June", 6),
         Month = replace(Month, Month == "July", 7),
         Month = replace(Month, Month == "August", 8),
         Month = replace(Month, Month == "September", 9),
         Month = replace(Month, Month == "October", 10),
         Month = replace(Month, Month == "November", 11),
         Month = replace(Month, Month == "December", 12),
         Month = as.integer(Month),
         date = lubridate::make_date(year = Year, month = Month, day = day),
         catch =   catch %>% oce::despike())
```

Clean species but seems ok
```{r}

kigamboni = catch.clean %>% 
  group_by(Species, Location) %>% 
  tally() %>% 
  arrange(desc(n)) %>% ungroup() %>% 
  filter(Location == "Kigamboni") %>%
  separate(col = Species, into = c("Species", "others"), sep = " " )%>% 
  mutate(percentage = (n/sum(n) * 100) %>% round(2), cumsum = cumsum(percentage),
         labs = paste(percentage,"%", Species)) %>%
  filter(cumsum <= 50) 
  
  
    
  kigamboni %>% 
    ggpubr::ggdonutchart(x = "n", 
                       label = "labs", 
                       fill = "Species", color = "white", lab.pos = "in")+
  # scale_fill_viridis_d() +
    scale_fill_brewer(palette = "Paired")+
  theme(legend.position = "none")  

```


```{r}
library(ggpubr)

# Data: Create some data
# +++++++++++++++++++++++++++++++

df <- data.frame(
 group = c("Male", "Female", "Child"),
  value = c(25, 25, 50))

head(df)


# Basic pie charts
# ++++++++++++++++++++++++++++++++

ggdonutchart(df, "value", label = "group")


# Change color
# ++++++++++++++++++++++++++++++++

# Change fill color by group
# set line color to white
# Use custom color palette
 ggdonutchart(df, "value", label = "group",
      fill = "group", color = "white",
       palette = c("#00AFBB", "#E7B800", "#FC4E07") )


# Change label
# ++++++++++++++++++++++++++++++++

# Show group names and value as labels
labs <- paste0(df$group, " (", df$value, "%)")
ggdonutchart(df, "value", label = labs,
   fill = "group", color = "white",
   palette = c("#00AFBB", "#E7B800", "#FC4E07"))

# Change the position and font color of labels
ggdonutchart(df, "value", label = labs,
   lab.pos = "in", lab.font = "white",
   fill = "group", color = "white",
   palette = c("#00AFBB", "#E7B800", "#FC4E07"))

```


```{r}
catch.clean.group = catch.clean %>% 
  group_by(Location, date) %>% 
  summarise(catch = median(catch, na.rm = TRUE)) %>%
  ungroup() 
```

## Fish catch trends
```{r}
catch.clean.group = catch.clean.group %>% 
  arrange(date)

 now= catch.clean.group %>% filter(catch > 250 & catch < 420) %>% 
   mutate(mwezi = lubridate::month(date, abbr = TRUE, label = TRUE),
          year = lubridate::year(date) %>% as.integer(),
          label = paste(mwezi, ", ",year))

formula1 <- y ~ x

ggplot(data = catch.clean.group , 
       aes(x = date, y = catch, col = Location, fill = Location))+
  geom_point()+
  geom_smooth(se = TRUE, alpha = .2, method = "lm", formula = formula1)+
  # stat_fit_tb(method = "lm",
  #             method.args = list(formula = formula1),
  #             tb.vars = c(Parameter = "term", 
  #                         Estimate = "estimate", 
  #                         "s.e." = "std.error", 
  #                         "italic(t)" = "statistic", 
  #                         "italic(P)" = "p.value"),
  #             label.y = "top", label.x = "right",
  #             parse = TRUE)+
  stat_poly_eq(aes(label = paste0("atop(", ..eq.label.., ",", ..rr.label.., ")")), 
               formula = formula1, rr.digits = 2,
               parse = TRUE) +
  # ggrepel::geom_text_repel(data = now, aes(x = date, y = catch, label = label)) +
  scale_x_date(date_minor_breaks = "1 month") +
  scale_y_continuous(breaks = seq(100,600,100))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = "none")+
  facet_wrap(~Location, scales = "free_y")+
  labs(x = "", y = "Fish catch (Tonnes)")
# ggsave("fig1.pdf")
```




```{r}

catch.clean.group.wide = catch.clean.group %>% ungroup() %>% select(date, Location, catch) %>% pivot_wider(names_from = "Location", values_from = "catch") %>% arrange(date) 


ts.series = ts.intersect(
  Kibiti = ts(data = catch.clean.group.wide %>% pull(Kibiti),start = c(2016,6), frequency = 12),
  Kilwa = ts(data = catch.clean.group.wide %>% pull(Kilwa),start = c(2016,6), frequency = 12),
  Mafia = ts(data = catch.clean.group.wide %>% pull(Mafia),start = c(2016,6), frequency = 12),
  Mtwara = ts(data = catch.clean.group.wide %>% pull(`Mtwara Rural`),start = c(2016,6), frequency = 12),
  Kigamboni = ts(data = catch.clean.group.wide %>% pull(Kigamboni),start = c(2016,6), frequency = 12)
  ) 

ts.series %>% 
  autoplot() +  
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = c(.80,.75))+
  scale_y_continuous(breaks = seq(100,600,100))+
  labs(x = "", y = "Fish catch (Tonnes)")

# ggsave("fig2.pdf")
```

We notice that only the catch data has few missing values. Then we use it to represent the trend of cath. Because the data ends in september 2019, we extended for two more years and forecast the catches of fish in this site until september 2021. We add six months moving average on the plot
```{r}
ts.series[,2] %>% 
  window(start = c(2016,11)) %>%
  autoplot() +
  autolayer(snaive(y = ts.series[,2]%>% window(start = c(2018,1)), h = 24), 
            series = "Future Catch", PI = FALSE, showgap = FALSE)+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), legend.position = c(.80,.75),)+
  scale_y_continuous(breaks = seq(100,600,100))+
  labs(x = "", y = "Fish catch (Tonnes)")+
  tidyquant::geom_ma(ma_fun = SMA,n=6, na.rm = TRUE) # for six moths moving average

```

general trend--catch sites pool together
```{r}
catch.clean.group
```

rumaki and non rumaki
```{r}

```

Rumaki---

composition
general 
rumaki and non-rumaki

change of specied dominance per year



```{r}
catch.districts = readxl::read_excel(path = "data_revised.xlsx",sheet = 2, col_names = TRUE ) %>% 
  select(year = 1, family = 2, english.name = 3, swahili.name = 4, district = 5, catch = 6, zone = 7) %>%
  mutate(year = as.integer(year), zone = as_factor(zone), english.name = as_factor(english.name), 
         swahili.name = as_factor(swahili.name), family = as_factor(family), district = as_factor(district),
         catch = as.numeric(catch))

```

```{r}
## check and remove outlier in the dataset

ggplot(data = catch.districts , aes(zone, catch, fill = year)) + geom_boxplot()
q = quantile(catch.districts$catch, na.rm = TRUE)
iqr = IQR(catch.districts$catch, na.rm = TRUE)

lower = q[2] - 1.5*iqr; upper = q[4]+ 1.5*iqr
ggplot(data = catch.districts %>% filter(catch <= upper) , 
       aes(zone, catch, fill = year)) + geom_boxplot()
```

```{r}
catch.districts%>% 
  # filter(catch < 1000) %>%
  filter(catch <= upper) %>%
  group_by(year, zone) %>% 
  summarise(n = n(),
            mean.catch = median(catch, na.rm = TRUE),
            sd = sd(catch, na.rm = TRUE),
            se = sd/sqrt(n)) %>%
  ungroup() %>% 
  ggplot(aes(x = year, y = mean.catch, col = zone)) +
  geom_line() +
  geom_point(size = 5)+
  geom_errorbar(aes(ymin = mean.catch-se, ymax = mean.catch+se), width = 0.075)+
  ggsci::scale_color_jco(name = "Fishing area", label = c("Non Rumaki", "Rumaki")) +
  scale_x_continuous(breaks = seq(2014,2016,1)) +
  scale_y_continuous(breaks = seq(0,95,15))+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"), 
        legend.position = "right", 
        legend.key.width = unit(2,"cm"))+
  labs(x = "", y = "Total Catch (Tonnes)")

# catch.districts %>% filter(catch < 1000) %>% ggplot(aes(x = year, y = catch, col = zone)) + geom_point()
```

```{r}
catch.districts%>% 
  # filter(catch > 50) %>%
  filter(catch <= upper) %>%
  group_by(family, zone, year)  %>% 
  count() %>% ungroup() %>% 
  filter(family != "Others") %>%
  # arrange((english.name)) %>% 
  ggplot(aes(x = family, y = n, fill = zone)) + 
  geom_col(position = "dodge")+ 
  coord_flip()+ 
  facet_wrap(~year)+
  cowplot::theme_minimal_grid()+
  theme(panel.grid = element_line(linetype = "dotted"))+
  ggsci::scale_fill_jco(name = "Fishing area", label = c("Non Rumaki", "Rumaki"))+
  scale_y_continuous(breaks = seq(2,9,2)) +
  labs(x = "Family group", y = "Number of appearance")+
  theme(axis.text.y = element_text(size = 10))
  



```





```{r}

catch.districts  %>% 
  filter(english.name != "Others", catch > 300)  %>% 
  group_by(english.name, zone, year)  %>% 
  count() %>% ungroup() %>% 
  pivot_wider(names_from = zone, values_from = n)%>% 
  mutate(OTHER = replace(OTHER, !is.na(OTHER),"present"),
         OTHER = replace(OTHER, is.na(OTHER),"absent"),
         RUMAKI = replace(RUMAKI, !is.na(RUMAKI),"present"),
         RUMAKI = replace(RUMAKI, is.na(RUMAKI),"absent")) %>%
  pivot_longer(names_to = "zone", values_to = "present.absent", cols = 3:4, ) %>% filter(present.absent == "present") %>% group_by(zone, english.name,year) %>% tally()


catch.districts  %>% 
  filter(english.name != "Others", catch > 300)  %>% 
  group_by(english.name, zone, year)  %>% 
  count() %>% ungroup() %>% 
  pivot_wider(names_from = zone, values_from = n)%>% 
  mutate(OTHER = replace(OTHER, !is.na(OTHER),"present"),
         OTHER = replace(OTHER, is.na(OTHER),"absent"),
         RUMAKI = replace(RUMAKI, !is.na(RUMAKI),"present"),
         RUMAKI = replace(RUMAKI, is.na(RUMAKI),"absent")) %>%
  filter(OTHER == "absent" & RUMAKI == "present") %>% 
  pivot_wider(names_from = year, values_from = 3:4) %>%
  kableExtra::kable(format = "html", caption = "Species found in Rumaki fishing area", 
                    col.names = c("Species", "2015", "2016", "2015", "2016")) %>%
  kableExtra::add_header_above(c("", "Non Rumaki" = 2, "Rumaki" = 2)) %>%
  kableExtra::column_spec(column = 1:5, width = "5cm")
```


```{r}
catch.districts  %>% 
  filter(english.name != "Others", catch > 300)  %>% 
  group_by(english.name, zone, year)  %>% 
  count() %>% ungroup() %>% 
  pivot_wider(names_from = zone, values_from = n)%>% 
  mutate(OTHER = replace(OTHER, !is.na(OTHER),"present"),
         OTHER = replace(OTHER, is.na(OTHER),"absent"),
         RUMAKI = replace(RUMAKI, !is.na(RUMAKI),"present"),
         RUMAKI = replace(RUMAKI, is.na(RUMAKI),"absent")) %>%
  filter(OTHER == "present" & RUMAKI == "absent") %>% pivot_wider(names_from = year, values_from = 3:4) %>%
  kableExtra::kable(format = "html", caption = "Species found in Non Rumaki fishing area", 
                    col.names = c("Species", "2015", "2016", "2015", "2016")) %>%
  kableExtra::add_header_above(c("", "Non Rumaki" = 2, "Rumaki" = 2)) %>%
  kableExtra::column_spec(column = 1:5, width = "5cm")
```


```{r}
catch.districts  %>% 
  filter(english.name != "Others", catch > 300)  %>% 
  group_by(english.name, zone, year)  %>% 
  count() %>% ungroup() %>% 
  pivot_wider(names_from = zone, values_from = n)%>% 
  mutate(OTHER = replace(OTHER, !is.na(OTHER),"present"),
         OTHER = replace(OTHER, is.na(OTHER),"absent"),
         RUMAKI = replace(RUMAKI, !is.na(RUMAKI),"present"),
         RUMAKI = replace(RUMAKI, is.na(RUMAKI),"absent")) %>%
  filter(OTHER == "present" & RUMAKI == "present") %>% pivot_wider(names_from = year, values_from = 3:4)  %>%
  kableExtra::kable(format = "html", caption = "Species found in Rumaki and Non-Rumaki fishing areas", 
                    col.names = c("Species", "2015", "2016", "2015", "2016")) %>%
  kableExtra::add_header_above(c("", "Non Rumaki" = 2, "Rumaki" = 2)) %>%
  kableExtra::column_spec(column = 1:5, width = "5cm")
```

```{r}
phyto = readxl::read_excel("c:/Users/Semba/Desktop/working/Maggie/Manuscripts/phytoplankton_combined.xls", sheet = 1) %>% mutate(date = lubridate::dmy(Date)) %>% select(date, Date, Station, everything())

phyto.pa = phyto %>% 
  dplyr::group_by(Station, Season, Diatoms) %>% 
  tally() %>% 
  ungroup() %>% 
  pivot_wider(names_from = Station, values_from = n) %>% 
  mutate(Mwaboza = replace(Mwaboza, !is.na(Mwaboza),"present"),
         Mwaboza = replace(Mwaboza, is.na(Mwaboza),"absent"),
         Sahare = replace(Sahare, !is.na(Sahare),"present"),
         Sahare = replace(Sahare, is.na(Sahare),"absent"),
         Vyeru = replace(Vyeru, !is.na(Vyeru),"present"),
         Vyeru = replace(Vyeru, is.na(Vyeru),"absent")) %>%
  pivot_longer(names_to = "sites", values_to = "present.absent", cols = 3:5) %>% filter(present.absent == "present") %>% group_by(sites, Season) %>% tally()


vyeru = phyto.pa%>%
  filter(sites == "Vyeru") %>% 
  mutate(percentage = (n/sum(n) * 100) %>% round(2), labs = paste(percentage, "%")) %>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "labs",
                       fill = "Season", color = "white", lab.pos = "in")+
  ggsci::scale_fill_jco()+
  theme(legend.position = "none")+
  labs(subtitle = "Vyeru")

mwabo = phyto.pa%>%
  filter(sites == "Mwaboza") %>% 
  mutate(percentage = (n/sum(n) * 100) %>% round(2), labs = paste(percentage, "%")) %>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "labs",
                       fill = "Season", color = "white", lab.pos = "in")+
  ggsci::scale_fill_jco()+
  theme(legend.position = "none")+
  labs(subtitle = "Mwaboza")

sahare = phyto.pa%>%
  filter(sites == "Sahare") %>% 
  mutate(percentage = (n/sum(n) * 100) %>% round(2), labs = paste(percentage, "%")) %>%
  ggpubr::ggdonutchart(x = "percentage", 
                       label = "labs",
                       fill = "Season", color = "white", lab.pos = "in")+
  ggsci::scale_fill_jco()+
  theme(legend.position = "right")+
  labs(subtitle = "Sahare")

egg::ggarrange(mwabo,vyeru,  sahare, nrow = 1)
```

```{r}
catch.districts %>% group_by(english.name, zone) %>% tally()%>% ungroup() %>% 
  pivot_wider(names_from = zone, values_from = n)

```

```{r}
catch.districts %>% group_by(english.name,zone) %>% count() %>% arrange(desc(n))
```

```{r}

```


<!--chapter:end:wwf_catch_Data_analysis.Rmd-->

